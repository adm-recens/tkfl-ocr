<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Validate Extracted Data</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet"/>
    <style>
      body{font-family:Arial,Helvetica,sans-serif;margin:18px}
      .card{border:1px solid #ddd;padding:12px;border-radius:6px;margin-bottom:12px}
      img{max-width:400px;display:block;margin-bottom:18px}
      textarea{width:100%;height:180px}
      .btn{padding:8px 12px;border-radius:6px;background:#007bff;color:white;border:none;cursor:pointer}
    </style>
</head>
<body>
  <h1>Validate Extracted Data</h1>
  {% if error %}
    <script>
      alert("{{ error }}");
      window.location.href = "{{ url_for('index') }}";
    </script>
  {% endif %}
  <div class="container" style="display:flex;gap:24px;align-items:flex-start">
    <div class="card">
      <h3>Uploaded Image</h3>
        <div style="position:relative;width:400px;">
          <img id="ocr-img" src="{{ image_url }}" alt="Uploaded Image" style="max-width:400px;display:block;" />
          <canvas id="ocr-canvas" width="400" style="position:absolute;top:0;left:0;pointer-events:none;"></canvas>
        </div>
        <form method="post" action="{{ rerun_url }}">
          <label for="ocr_model">OCR Model:</label>
          <select name="ocr_model" id="ocr_model" disabled>
            <option value="tesseract" selected>Tesseract</option>
          </select>
          <label for="mode">Preprocessing:</label>
          <select name="mode" id="mode" name="mode">
            <option value="default" {% if selected_mode == 'default' %}selected{% endif %}>Default</option>
            <option value="contrast" {% if selected_mode == 'contrast' %}selected{% endif %}>Contrast</option>
            <option value="threshold" {% if selected_mode == 'threshold' %}selected{% endif %}>Threshold</option>
            <option value="resize" {% if selected_mode == 'resize' %}selected{% endif %}>Resize</option>
          </select>
          <button class="btn" type="submit">Rerun OCR</button>
        </form>
        <div style="margin-top:8px;font-size:14px;color:#555">
          <b>Preprocessing modes:</b><br>
          <b>Default:</b> Grayscale + median filter (removes noise)<br>
          <b>Contrast:</b> Grayscale + auto contrast (improves faded text)<br>
          <b>Threshold:</b> Grayscale + binary threshold (for high-contrast text)<br>
          <b>Resize:</b> Doubles image size (helps with small text)<br>
        </div>
    </div>
    <div class="card">
      <h3>Extracted OCR Text</h3>
      <form method="post" action="{{ save_url }}">
        <textarea name="ocr_text" style="width:400px;height:400px">{{ ocr_text }}</textarea>
        <button class="btn" type="submit">Save to Database</button>
      </form>
      <form method="get" action="{{ url_for('index') }}" style="margin-top:12px">
        <button class="btn" type="submit" style="background:#6c757d">Exit without Saving</button>
      </form>
    </div>
  </div>
  <script>
    window.onload = function() {
      var boxes = JSON.parse('{{ ocr_boxes|tojson|safe }}');
      var img = document.getElementById('ocr-img');
      var canvas = document.getElementById('ocr-canvas');
      var ctx = canvas.getContext('2d');
      function drawBoxes() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        var scale = img.naturalWidth ? (canvas.width / img.naturalWidth) : 1;
        boxes.forEach(function(box) {
          ctx.strokeStyle = '#ff0000';
          ctx.lineWidth = 2;
          ctx.strokeRect(box.left * scale, box.top * scale, box.width * scale, box.height * scale);
        });
      }
      if (img.complete) {
        drawBoxes();
      } else {
        img.onload = drawBoxes;
      }
    };
  </script>
</body>
</html>
